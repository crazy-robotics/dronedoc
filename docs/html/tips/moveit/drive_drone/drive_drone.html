

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="ja" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="ja" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>MoveIt!を使ってGazeboモデルを動かす &mdash; Dronedoc 1.0.0 ドキュメント</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="検索" href="../../../search.html" />
    <link rel="next" title="基本的なBashの使い方" href="../../../appendix/bash_commands/bash_commands.html" />
    <link rel="prev" title="MoveIt!のRvizデモを試す" href="../run_demo/run_demo.html" /> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> Dronedoc
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../introduction.html">はじめに</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../px4sim/px4sim.html">PX4 SITLシミュレーション</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../runnode/runnodecpp.html">自作ノードを実行する（C++）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../runnode/runnodepy.html">自作ノードを実行する（Python）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../addmodel/addmodel.html">新しいモデルを追加する</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../slam/slam.html">自律飛行とSLAM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../slam/gps_nav.html">GPSを用いた自律飛行</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../slam/turtle_mapping.html">Turtlebotを使ってマップを作る</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../teleop/teleop.html">ゲームパッドを使ってドローンを操作する</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../slam/lidar_localization.html">LiDARとAMCLを用いた自己位置推定</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../slam/localization_and_mapping.html">LiDARを用いたSLAM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../slam/lidar_nav.html">LiDARを用いた自律移動</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../octomap/octomap.html">Octomapを使って3Dマップを作る</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Tips</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../qgc_intro/qgc_intro.html">QGroundControl</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../add_range_sensor/add_range_sensor.html">ドローンに距離センサを搭載する</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../filter_lidar/filter_lidar.html">LiDARのデータをフィルタリングする</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../change_local_planner/change_local_planner.html">move_baseのローカルプランナーを変更する</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../local_planner_for_uav/local_planner_for_uav.html">UAV用のローカルプランナを実装する</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../build_map_gmapping/build_map_gmapping.html">Gmappingを使って地図を生成する</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../build_map_gazebo_plugin/build_map_gazebo_plugin.html">Gazebo Pluginを使って地図を作成する</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../airsim/airsim.html">AirSimシミュレータを使う</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">MoveIt!を使ってドローンの経路計画を行う</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../create_config_pkg/create_config_pkg.html">iris_moveit_configパッケージを作る</a></li>
<li class="toctree-l3"><a class="reference internal" href="../run_demo/run_demo.html">MoveIt!のRvizデモを試す</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">MoveIt!を使ってGazeboモデルを動かす</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#moveit">MoveIt!を用いてロボットを動かす方法</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id1">全体の構成</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">Controller</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">Controller Handle</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">Controller Manager</a></li>
<li class="toctree-l4"><a class="reference internal" href="#launch-files">Launch files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#execution">Execution</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">まとめ</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">参考</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Appendix</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../appendix/bash_commands/bash_commands.html">基本的なBashの使い方</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../appendix/ros/ros.html">ROSの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../appendix/terms/terms.html">用語集</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../appendix/archive/archive.html">読書案内</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../appendix/trouble_shooting/index.html">トラブルシューティング</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Dronedoc</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Tips</a> &raquo;</li>
        
          <li><a href="../index.html">MoveIt!を使ってドローンの経路計画を行う</a> &raquo;</li>
        
      <li>MoveIt!を使ってGazeboモデルを動かす</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/tips/moveit/drive_drone/drive_drone.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="moveit-gazebo">
<h1>MoveIt!を使ってGazeboモデルを動かす<a class="headerlink" href="#moveit-gazebo" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p>この記事では、前回までに作成したiris_moveit_configパッケージとMoveIt! RVizプラグインを使って経路計画を行い、ドローンの制御を行います。</p>
<div class="section" id="moveit">
<h2>MoveIt!を用いてロボットを動かす方法<a class="headerlink" href="#moveit" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="moveitsimplecontrollermanager">
<h3>MoveItSimpleControllerManager<a class="headerlink" href="#moveitsimplecontrollermanager" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>RVizで表示されるのはプランだけなので実際にロボットを動かすにはコントローラーが必要。
コントローラーマネージャ（MoveItSimpleControllerManager）がコントローラーハンドラ（follow_joint_trajectory_controller_handler）を登録し、FollowJointTrajectoryアクションを使ってコントローラー（FollowJointTrajectoryアクションのサーバーを提供するものなら何でもよい）に経路の情報を送る。
コントローラーは、コントローラーハンドラから送られてきた情報を元にロボットに制御指令を送り、実行結果や実行途中の状態をハンドラに送り返す。</p>
<p>コントローラーマネージャは、 <code class="docutils literal notranslate"><span class="pre">controller_list</span></code> パラメータに指定されたコントローラハンドラをMoveIt!に登録する。
MoveIt!に登録されたコントローラハンドラには（trajectory_execution_managerがsendTrajectoryを呼ぶことで）、経路の情報（RobotTrajectory）が与えられるので、これをアクションのゴールとして送信する。
MoveItSimpleControllerManagerは、follow_joint_trajectory_controller_handlerとgripper_controller_handlerだけに対応している。
follow_joint_trajectory_controller_handlerは他自由度の関節には対応していないので、他自由度の関節に対応したハンドラを使うためには、マネージャとハンドラの双方を新しく作成する必要がある。</p>
<p>自作のコントローラーマネージャを使う場合には、インターフェースクラスを継承したマネージャをmoveit_coreのプラグインとして登録する必要がある。</p>
<p>上述のように、この例ではコントローラハンドラは内部でアクションクライアントを定義しており、経路が実行されるタイミングでsendTrajectoryメソッドがコールされ、アクションのゴールが送信される。
そのため、経路の情報を使用してロボットを制御するためには、アクションに対応したアクションサーバーを作成する必要がある（コントローラ内でも別でもよい）。
コントローラは、コントローラハンドルから渡ってきた経路の情報を元にロボットを制御する。</p>
<ul class="simple">
<li><a class="reference external" href="http://wiki.ros.org/moveit_msgs">http://wiki.ros.org/moveit_msgs</a></li>
<li><a class="reference external" href="http://docs.ros.org/kinetic/api/moveit_tutorials/html/doc/controller_configuration/controller_configuration_tutorial.html">http://docs.ros.org/kinetic/api/moveit_tutorials/html/doc/controller_configuration/controller_configuration_tutorial.html</a></li>
</ul>
<div class="section" id="actionlib">
<h4>actionlib<a class="headerlink" href="#actionlib" title="このヘッドラインへのパーマリンク">¶</a></h4>
</div>
<div class="section" id="pluginlib">
<h4>pluginlib<a class="headerlink" href="#pluginlib" title="このヘッドラインへのパーマリンク">¶</a></h4>
<ul class="simple">
<li><a class="reference external" href="http://wiki.ros.org/pluginlib/Tutorials/Writing%20and%20Using%20a%20Simple%20Plugin">http://wiki.ros.org/pluginlib/Tutorials/Writing%20and%20Using%20a%20Simple%20Plugin</a></li>
<li><a class="reference external" href="http://wiki.ros.org/pluginlib/Troubleshooting">http://wiki.ros.org/pluginlib/Troubleshooting</a></li>
</ul>
</div>
</div>
<div class="section" id="ros-control">
<h3>ros_control<a class="headerlink" href="#ros-control" title="このヘッドラインへのパーマリンク">¶</a></h3>
</div>
</div>
<div class="section" id="id1">
<h2>全体の構成<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>アプリケーション全体の構成は以下のようになっています。</p>
<img alt="../../../_images/moveit_uav.png" src="../../../_images/moveit_uav.png" />
<div class="section" id="rviz">
<h3>RViz<a class="headerlink" href="#rviz" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>RVizは <a class="reference internal" href="../run_demo/run_demo.html"><span class="doc">MoveIt!のRvizデモを試す</span></a> で見たように、経路の設定をMoveIt!側に送り、MoveIt!が生成した経路の情報を元に可視化を行います。</p>
</div>
<div class="section" id="controller">
<h3>Controller<a class="headerlink" href="#controller" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>MoveIt!の提供するロボットを制御するための制御入力を計算し</p>
<p>今回は、 <code class="docutils literal notranslate"><span class="pre">FollowMultiDOFJointTrajectory</span></code> アクションのGoalを受け取り、それをドローンに目標位置として送信するノードをコントローラーとして用います。</p>
</div>
<div class="section" id="controller-handle">
<h3>Controller Handle<a class="headerlink" href="#controller-handle" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>あ</p>
</div>
<div class="section" id="controller-manager">
<h3>Controller Manager<a class="headerlink" href="#controller-manager" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Controller Managerはロボットを制御するための各種Controller Handle（FollowJointTrajectoryなど）をMoveIt!に登録する役割があります。
Controller</p>
</div>
</div>
<div class="section" id="id2">
<h2>Controller<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="literal-block-wrapper container" id="id8">
<div class="code-block-caption"><span class="caption-text">drone_controller.cpp</span><a class="headerlink" href="#id8" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * @file drone_controller.cpp</span>
<span class="cm"> * @brief PX4 based UAV controller for moveit</span>
<span class="cm"> */</span>

<span class="cp">#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;array&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cmath&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;ros/ros.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;geometry_msgs/Transform.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;geometry_msgs/PoseStamped.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;moveit_msgs/ExecuteTrajectoryAction.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;moveit_msgs/RobotTrajectory.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;mavros_msgs/State.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;trajectory_msgs/MultiDOFJointTrajectory.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;trajectory_msgs/MultiDOFJointTrajectoryPoint.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;actionlib/server/simple_action_server.h&gt;</span><span class="cp"></span>

<span class="k">class</span> <span class="nc">DroneController</span><span class="p">{</span>

<span class="k">private</span><span class="o">:</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">NodeHandle</span> <span class="n">nh_</span><span class="p">;</span>
    <span class="c1">//! Action name of ExecuteTrajectory</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">action_name_</span><span class="p">;</span>
    <span class="c1">//! Server of ExecuteTrajectoryAction</span>
    <span class="n">actionlib</span><span class="o">::</span><span class="n">SimpleActionServer</span><span class="o">&lt;</span><span class="n">moveit_msgs</span><span class="o">::</span><span class="n">ExecuteTrajectoryAction</span><span class="o">&gt;</span> <span class="n">as_</span><span class="p">;</span>
    <span class="c1">//! Feedback message of ExecuteTrajectoryAction</span>
    <span class="n">moveit_msgs</span><span class="o">::</span><span class="n">ExecuteTrajectoryFeedback</span> <span class="n">feedback_</span><span class="p">;</span>
    <span class="c1">//! Result message of ExecuteTrajectoryAction</span>
    <span class="n">moveit_msgs</span><span class="o">::</span><span class="n">ExecuteTrajectoryResult</span> <span class="n">result_</span><span class="p">;</span>
    <span class="c1">//! Position command publisher</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span> <span class="n">cmd_pos_pub_</span><span class="p">;</span>
    <span class="c1">//! Subscriber of local position</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">Subscriber</span> <span class="n">local_pos_sub_</span><span class="p">;</span>
    <span class="c1">//! Subscriber of UAV state</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">Subscriber</span> <span class="n">state_sub_</span><span class="p">;</span>
    <span class="c1">//! Current pose of UAV</span>
    <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span> <span class="n">current_pose_</span><span class="p">;</span>
    <span class="c1">//! Current state of UAV</span>
    <span class="n">mavros_msgs</span><span class="o">::</span><span class="n">State</span> <span class="n">current_state_</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>

    <span class="cm">/**</span>
<span class="cm">     * @brief Constructor</span>
<span class="cm">     * @param action_name Action name</span>
<span class="cm">     */</span>
    <span class="n">DroneController</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">action_name</span><span class="p">)</span> <span class="o">:</span>
        <span class="n">action_name_</span><span class="p">(</span><span class="n">action_name</span><span class="p">),</span>
        <span class="n">as_</span><span class="p">(</span><span class="n">nh_</span><span class="p">,</span> <span class="n">action_name</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DroneController</span><span class="o">::</span><span class="n">executeCb</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">),</span> <span class="nb">false</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">as_</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>

        <span class="c1">// Position command publisher setup</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">cmd_pos_topic</span><span class="p">;</span>
        <span class="n">nh_</span><span class="p">.</span><span class="n">param</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;mavros_setpoint_topic&quot;</span><span class="p">,</span> <span class="n">cmd_pos_topic</span><span class="p">,</span> <span class="s">&quot;/mavros/setpoint_position/local&quot;</span><span class="p">);</span>
        <span class="n">cmd_pos_pub_</span> <span class="o">=</span> <span class="n">nh_</span><span class="p">.</span><span class="n">advertise</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cmd_pos_topic</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

        <span class="c1">// Local position subscriber setup</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">local_pos_topic</span><span class="p">;</span>
        <span class="n">nh_</span><span class="p">.</span><span class="n">param</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;mavros_localpos_topic&quot;</span><span class="p">,</span> <span class="n">local_pos_topic</span><span class="p">,</span> <span class="s">&quot;/mavros/local_position/pose&quot;</span><span class="p">);</span>
        <span class="k">auto</span> <span class="n">local_pos_cb</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DroneController</span><span class="o">::</span><span class="n">localPosCb</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">);</span>
        <span class="n">local_pos_sub_</span> <span class="o">=</span> <span class="n">nh_</span><span class="p">.</span><span class="n">subscribe</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span><span class="o">&gt;</span><span class="p">(</span><span class="n">local_pos_topic</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">local_pos_cb</span><span class="p">);</span>

        <span class="c1">// UAV state subscriber setup</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">state_topic</span><span class="p">;</span>
        <span class="n">nh_</span><span class="p">.</span><span class="n">param</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;mavros_state_topic&quot;</span><span class="p">,</span> <span class="n">state_topic</span><span class="p">,</span> <span class="s">&quot;/mavros/state&quot;</span><span class="p">);</span>
        <span class="k">auto</span> <span class="n">state_cb</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DroneController</span><span class="o">::</span><span class="n">stateCb</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">);</span>
        <span class="n">state_sub_</span> <span class="o">=</span> <span class="n">nh_</span><span class="p">.</span><span class="n">subscribe</span><span class="o">&lt;</span><span class="n">mavros_msgs</span><span class="o">::</span><span class="n">State</span><span class="o">&gt;</span><span class="p">(</span><span class="n">state_topic</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">state_cb</span><span class="p">);</span>
        <span class="n">ROS_INFO</span><span class="p">(</span><span class="s">&quot;Action server initialized.&quot;</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="cm">/**</span>
<span class="cm">     * @brief Destructor</span>
<span class="cm">     */</span>
    <span class="o">~</span><span class="n">DroneController</span><span class="p">()</span>
    <span class="p">{</span>
    <span class="p">};</span>

<span class="k">private</span><span class="o">:</span>

    <span class="cm">/**</span>
<span class="cm">     * @brief Callback of ExecuteTrajectory action</span>
<span class="cm">     * @param goal Goal of ExecuteTrajectory action</span>
<span class="cm">     */</span>
    <span class="kt">void</span> <span class="n">executeCb</span><span class="p">(</span><span class="k">const</span> <span class="n">moveit_msgs</span><span class="o">::</span><span class="n">ExecuteTrajectoryGoalConstPtr</span> <span class="o">&amp;</span><span class="n">goal</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ROS_INFO</span><span class="p">(</span><span class="s">&quot;Action received.&quot;</span><span class="p">);</span>
        <span class="n">ros</span><span class="o">::</span><span class="n">Rate</span> <span class="n">rate</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

        <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">trajectory_msgs</span><span class="o">::</span><span class="n">MultiDOFJointTrajectoryPoint</span><span class="o">&gt;</span> <span class="n">trajectory</span><span class="p">;</span>
        <span class="n">trajectory</span> <span class="o">=</span> <span class="n">goal</span><span class="o">-&gt;</span><span class="n">trajectory</span><span class="p">.</span><span class="n">multi_dof_joint_trajectory</span><span class="p">.</span><span class="n">points</span><span class="p">;</span>

        <span class="c1">// Wait for connection</span>
        <span class="n">ROS_INFO</span><span class="p">(</span><span class="s">&quot;Waiting for FCU connection...&quot;</span><span class="p">);</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">ros</span><span class="o">::</span><span class="n">ok</span><span class="p">()</span> <span class="n">and</span> <span class="n">not</span> <span class="n">current_state_</span><span class="p">.</span><span class="n">connected</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ros</span><span class="o">::</span><span class="n">spinOnce</span><span class="p">();</span>
            <span class="n">rate</span><span class="p">.</span><span class="n">sleep</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="n">ROS_INFO</span><span class="p">(</span><span class="s">&quot;FCU connection established.&quot;</span><span class="p">);</span>

        <span class="c1">// Position command need to be published to switch mode to OFFBOARD</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">cmd_pos_pub_</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">getPoseFromTrajectory</span><span class="p">(</span><span class="n">trajectory</span><span class="p">.</span><span class="n">front</span><span class="p">()));</span>
        <span class="p">}</span>


        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">trajectory</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ROS_INFO</span><span class="p">(</span><span class="s">&quot;Moving to waypoint No. %d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

            <span class="c1">// Send feedback (progress of path)</span>
            <span class="n">feedback_</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
            <span class="n">as_</span><span class="p">.</span><span class="n">publishFeedback</span><span class="p">(</span><span class="n">feedback_</span><span class="p">);</span>

            <span class="c1">// Get PoseStamped message from MultiDOFJointTrajectoryPoint</span>
            <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span> <span class="n">start</span> <span class="o">=</span> <span class="n">getPoseFromTrajectory</span><span class="p">(</span><span class="n">trajectory</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
            <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span> <span class="n">goal</span> <span class="o">=</span> <span class="n">getPoseFromTrajectory</span><span class="p">(</span><span class="n">trajectory</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
            <span class="c1">// Get interpolated path from two waypoints</span>
            <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span><span class="o">&gt;</span> <span class="n">path</span> <span class="o">=</span> <span class="n">getBilinearPath</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">goal</span><span class="p">);</span>

            <span class="c1">// Publish all interpolated points</span>
            <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="nl">pose</span><span class="p">:</span> <span class="n">path</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// Publish same message till drone arrives to local goal</span>
                <span class="k">while</span><span class="p">(</span><span class="n">not</span> <span class="n">isGoalReached</span><span class="p">(</span><span class="n">pose</span><span class="p">)</span> <span class="n">and</span> <span class="n">not</span> <span class="n">as_</span><span class="p">.</span><span class="n">isPreemptRequested</span><span class="p">())</span>
                <span class="p">{</span>
                    <span class="n">cmd_pos_pub_</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">pose</span><span class="p">);</span>
                    <span class="n">rate</span><span class="p">.</span><span class="n">sleep</span><span class="p">();</span>
                <span class="p">}</span>

                <span class="c1">// Exit loop if new action arrived</span>
                <span class="k">if</span><span class="p">(</span><span class="n">as_</span><span class="p">.</span><span class="n">isPreemptRequested</span><span class="p">()</span> <span class="n">or</span> <span class="n">not</span> <span class="n">ros</span><span class="o">::</span><span class="n">ok</span><span class="p">())</span>
                <span class="p">{</span>
                    <span class="n">result_</span><span class="p">.</span><span class="n">error_code</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">moveit_msgs</span><span class="o">::</span><span class="n">MoveItErrorCodes</span><span class="o">::</span><span class="n">PREEMPTED</span><span class="p">;</span>
                    <span class="n">as_</span><span class="p">.</span><span class="n">setPreempted</span><span class="p">();</span>
                    <span class="n">ROS_INFO</span><span class="p">(</span><span class="s">&quot;Action preempted.&quot;</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="c1">// Exit loop if new action arrived</span>
            <span class="k">if</span><span class="p">(</span><span class="n">as_</span><span class="p">.</span><span class="n">isPreemptRequested</span><span class="p">()</span> <span class="n">or</span> <span class="n">not</span> <span class="n">ros</span><span class="o">::</span><span class="n">ok</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="n">result_</span><span class="p">.</span><span class="n">error_code</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">moveit_msgs</span><span class="o">::</span><span class="n">MoveItErrorCodes</span><span class="o">::</span><span class="n">PREEMPTED</span><span class="p">;</span>
                <span class="n">as_</span><span class="p">.</span><span class="n">setPreempted</span><span class="p">();</span>
                <span class="n">ROS_INFO</span><span class="p">(</span><span class="s">&quot;Action preempted.&quot;</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">rate</span><span class="p">.</span><span class="n">sleep</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="c1">// Success</span>
        <span class="n">result_</span><span class="p">.</span><span class="n">error_code</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">moveit_msgs</span><span class="o">::</span><span class="n">MoveItErrorCodes</span><span class="o">::</span><span class="n">SUCCESS</span><span class="p">;</span>
        <span class="n">as_</span><span class="p">.</span><span class="n">setSucceeded</span><span class="p">(</span><span class="n">result_</span><span class="p">);</span>
        <span class="n">ROS_INFO</span><span class="p">(</span><span class="s">&quot;Action completed.&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * @brief Return interpolated path using bilinear interpolation from two waypoints</span>
<span class="cm">     * @param start Start waypoint</span>
<span class="cm">     * @param goal Goal waypoint</span>
<span class="cm">     * @param step Step size of interpolation</span>
<span class="cm">     */</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span><span class="o">&gt;</span> <span class="n">getBilinearPath</span><span class="p">(</span><span class="k">const</span> <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span> <span class="o">&amp;</span><span class="n">start</span><span class="p">,</span>
                                                            <span class="k">const</span> <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span> <span class="o">&amp;</span><span class="n">goal</span><span class="p">,</span>
                                                            <span class="k">const</span> <span class="kt">double</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span><span class="o">&gt;</span> <span class="n">bilinear_path</span><span class="p">;</span>

        <span class="c1">// Store x-y and x-z coordinates of start point</span>
        <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">start_xy</span> <span class="o">=</span> <span class="p">{</span><span class="n">start</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">start</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span><span class="p">};</span>
        <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">start_xz</span> <span class="o">=</span> <span class="p">{</span><span class="n">start</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">start</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span><span class="p">};</span>
        <span class="c1">// Store x-y and x-z coordinates of goal point</span>
        <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">goal_xy</span> <span class="o">=</span> <span class="p">{</span><span class="n">goal</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">goal</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span><span class="p">};</span>
        <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">goal_xz</span> <span class="o">=</span> <span class="p">{</span><span class="n">goal</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">goal</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span><span class="p">};</span>

        <span class="c1">// x-y and x-z coordinates of interpolated points</span>
        <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">points_xy</span> <span class="o">=</span> <span class="n">linearInterp</span><span class="p">(</span><span class="n">start_xy</span><span class="p">,</span> <span class="n">goal_xy</span><span class="p">,</span> <span class="n">step</span><span class="p">);</span>
        <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">points_xz</span> <span class="o">=</span> <span class="n">linearInterp</span><span class="p">(</span><span class="n">start_xz</span><span class="p">,</span> <span class="n">goal_xz</span><span class="p">,</span> <span class="n">step</span><span class="p">);</span>

        <span class="c1">// Number of generated points by interpolation</span>
        <span class="kt">int</span> <span class="n">num_points</span> <span class="o">=</span> <span class="n">points_xy</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">size</span><span class="p">();</span>

        <span class="k">try</span>
        <span class="p">{</span>
            <span class="c1">// Generate PoseStamped message from std::array</span>
            <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">num_points</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span> <span class="n">pose</span><span class="p">;</span>
                <span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="n">start</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">;</span>
                <span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">points_xy</span><span class="p">.</span><span class="n">front</span><span class="p">().</span><span class="n">at</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
                <span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">points_xy</span><span class="p">.</span><span class="n">back</span><span class="p">().</span><span class="n">at</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
                <span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">points_xz</span><span class="p">.</span><span class="n">back</span><span class="p">().</span><span class="n">at</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

                <span class="n">bilinear_path</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pose</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">out_of_range</span> <span class="o">&amp;</span><span class="n">ex</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ROS_ERROR</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">bilinear_path</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * @brief Perform linear interpolation</span>
<span class="cm">     * @p1 First point</span>
<span class="cm">     * @p2 Second point</span>
<span class="cm">     * @step Step size of interpolation</span>
<span class="cm">     */</span>
    <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">linearInterp</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">p1</span><span class="p">,</span>
                                                    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">p2</span><span class="p">,</span> <span class="k">const</span> <span class="kt">double</span> <span class="n">step</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Gradient</span>
        <span class="kt">double</span> <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">p1</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">p2</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">p1</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">p2</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
        <span class="c1">// Intercept</span>
        <span class="kt">double</span> <span class="n">b</span> <span class="o">=</span> <span class="n">p1</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="n">p1</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

        <span class="c1">// Number of steps</span>
        <span class="kt">int</span> <span class="n">num_steps</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">floor</span><span class="p">((</span><span class="n">p2</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">p1</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">/</span><span class="n">step</span><span class="p">);</span>

        <span class="c1">// Initialize container for interpolated points</span>
        <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">points_x</span><span class="p">(</span><span class="n">num_steps</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>

        <span class="c1">// Set interpolated points</span>
        <span class="n">points_x</span><span class="p">.</span><span class="n">front</span><span class="p">()</span> <span class="o">=</span> <span class="n">p1</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">num_steps</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">points_x</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">step</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="n">p1</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">points_x</span><span class="p">.</span><span class="n">back</span><span class="p">()</span> <span class="o">=</span> <span class="n">p2</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

        <span class="c1">// Initialize container for interpolated points</span>
        <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">points_y</span><span class="p">(</span><span class="n">num_steps</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>

        <span class="c1">// Set interpolated points</span>
        <span class="n">points_y</span><span class="p">.</span><span class="n">front</span><span class="p">()</span> <span class="o">=</span> <span class="n">p1</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">num_steps</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">points_y</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">p1</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">step</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">points_y</span><span class="p">.</span><span class="n">back</span><span class="p">()</span> <span class="o">=</span> <span class="n">p2</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

        <span class="c1">// Initialize container for vector of points</span>
        <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">points</span><span class="p">;</span>
        <span class="n">points</span><span class="p">.</span><span class="n">front</span><span class="p">()</span> <span class="o">=</span> <span class="n">points_x</span><span class="p">;</span>
        <span class="n">points</span><span class="p">.</span><span class="n">back</span><span class="p">()</span> <span class="o">=</span> <span class="n">points_y</span><span class="p">;</span>

        <span class="k">return</span> <span class="n">points</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * @brief Convert MultiDOFJointTrajectoryPoint message to PoseStamped message</span>
<span class="cm">     * @param trajectory_pt MultiDOFJointTrajectoryPoint message</span>
<span class="cm">     */</span>
    <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span> <span class="n">getPoseFromTrajectory</span><span class="p">(</span><span class="k">const</span> <span class="n">trajectory_msgs</span><span class="o">::</span><span class="n">MultiDOFJointTrajectoryPoint</span> <span class="o">&amp;</span><span class="n">trajectory_pt</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span> <span class="n">pose</span><span class="p">;</span>

        <span class="n">pose</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="n">ros</span><span class="o">::</span><span class="n">Time</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
        <span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">trajectory_pt</span><span class="p">.</span><span class="n">transforms</span><span class="p">.</span><span class="n">front</span><span class="p">().</span><span class="n">translation</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
        <span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">trajectory_pt</span><span class="p">.</span><span class="n">transforms</span><span class="p">.</span><span class="n">front</span><span class="p">().</span><span class="n">translation</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
        <span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">trajectory_pt</span><span class="p">.</span><span class="n">transforms</span><span class="p">.</span><span class="n">front</span><span class="p">().</span><span class="n">translation</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
        <span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="n">trajectory_pt</span><span class="p">.</span><span class="n">transforms</span><span class="p">.</span><span class="n">front</span><span class="p">().</span><span class="n">rotation</span><span class="p">;</span>

        <span class="k">return</span> <span class="n">pose</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * @brief Returns true if drone is reached goal</span>
<span class="cm">     * @param goal</span>
<span class="cm">     * @param tolerance Consider drone reached goal if drone is within the circle with diameter of this value</span>
<span class="cm">     */</span>
    <span class="kr">inline</span> <span class="kt">bool</span> <span class="n">isGoalReached</span><span class="p">(</span><span class="k">const</span> <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span> <span class="o">&amp;</span><span class="n">goal</span><span class="p">,</span> <span class="k">const</span> <span class="kt">double</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">double</span> <span class="n">error</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">sqrt</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">pow</span><span class="p">(</span><span class="n">goal</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">current_pose_</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                                 <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">pow</span><span class="p">(</span><span class="n">goal</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">current_pose_</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                                 <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">pow</span><span class="p">(</span><span class="n">goal</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">current_pose_</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
        <span class="k">return</span> <span class="n">error</span> <span class="o">&lt;</span> <span class="n">tolerance</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * @brief Callback for local position subscriber</span>
<span class="cm">     * @msg Incoming message</span>
<span class="cm">     */</span>
    <span class="kt">void</span> <span class="n">localPosCb</span><span class="p">(</span><span class="k">const</span> <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span><span class="o">::</span><span class="n">ConstPtr</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">current_pose_</span> <span class="o">=</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * @brief Callback for state subscriber</span>
<span class="cm">     * @msg Incoming message</span>
<span class="cm">     */</span>
    <span class="kt">void</span> <span class="n">stateCb</span><span class="p">(</span><span class="k">const</span> <span class="n">mavros_msgs</span><span class="o">::</span><span class="n">State</span><span class="o">::</span><span class="n">ConstPtr</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">current_state_</span> <span class="o">=</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argc</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="s">&quot;drone_controller&quot;</span><span class="p">);</span>

    <span class="n">DroneController</span> <span class="n">controller</span><span class="p">(</span><span class="s">&quot;iris_group_controller/follow_multi_dof_joint_trajectory&quot;</span><span class="p">);</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">spin</span><span class="p">();</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="id3">
<h2>Controller Handle<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="literal-block-wrapper container" id="id9">
<div class="code-block-caption"><span class="caption-text">follow_multi_dof_joint_trajectory_controller_handle.hpp</span><a class="headerlink" href="#id9" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * @file follow_multi_dof_joint_trajectory_controller_handle.cpp</span>
<span class="cm"> * @brief Action client for ExecuteTrajectory action</span>
<span class="cm"> */</span>

<span class="cp">#ifndef MOVEIT_PLUGINS_FOLLOW_MULTI_DOF_TRAJECTORY_CONTROLLER_HANDLE</span>
<span class="cp">#define MOVEIT_PLUGINS_FOLLOW_MULTI_DOF_TRAJECTORY_CONTROLLER_HANDLE</span>

<span class="cp">#include</span> <span class="cpf">&lt;moveit_simple_controller_manager/action_based_controller_handle.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;moveit_msgs/ExecuteTrajectoryAction.h&gt;</span><span class="cp"></span>

<span class="k">namespace</span> <span class="n">moveit_multi_dof_controller_manager</span>
<span class="p">{</span>
<span class="cm">/**</span>
<span class="cm"> * @brief Controller for multi DOF joint trajectory</span>
<span class="cm"> *</span>
<span class="cm"> * This is generally used for arms, but could also be used for multi-dof hands,</span>
<span class="cm"> * or anything using a control_mgs/FollowJointTrajectoryAction.</span>
<span class="cm"> */</span>
<span class="k">class</span> <span class="nc">FollowMultiDOFJointTrajectoryControllerHandle</span>
    <span class="o">:</span> <span class="k">public</span> <span class="n">moveit_simple_controller_manager</span><span class="o">::</span><span class="n">ActionBasedControllerHandle</span><span class="o">&lt;</span><span class="n">moveit_msgs</span><span class="o">::</span><span class="n">ExecuteTrajectoryAction</span><span class="o">&gt;</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>

  <span class="cm">/**</span>
<span class="cm">   * @brief Constructor</span>
<span class="cm">   * @param name</span>
<span class="cm">   * @param action_ns</span>
<span class="cm">   */</span>
  <span class="n">FollowMultiDOFJointTrajectoryControllerHandle</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">action_ns</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">ActionBasedControllerHandle</span><span class="o">&lt;</span><span class="n">moveit_msgs</span><span class="o">::</span><span class="n">ExecuteTrajectoryAction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">action_ns</span><span class="p">)</span>
  <span class="p">{</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * @brief Send ExecuteTrajectoryGoal message to action server</span>
<span class="cm">   * @param trajectory Trajectory to follow</span>
<span class="cm">   */</span>
  <span class="kt">bool</span> <span class="n">sendTrajectory</span><span class="p">(</span><span class="k">const</span> <span class="n">moveit_msgs</span><span class="o">::</span><span class="n">RobotTrajectory</span><span class="o">&amp;</span> <span class="n">trajectory</span><span class="p">)</span> <span class="k">override</span>
  <span class="p">{</span>
    <span class="n">ROS_DEBUG_STREAM_NAMED</span><span class="p">(</span><span class="s">&quot;FollowMultiDOFJointTrajectoryController&quot;</span><span class="p">,</span> <span class="s">&quot;new trajectory to &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">name_</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">controller_action_client_</span><span class="p">)</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">trajectory</span><span class="p">.</span><span class="n">joint_trajectory</span><span class="p">.</span><span class="n">points</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">ROS_WARN_NAMED</span><span class="p">(</span><span class="s">&quot;FollowMultiDOFJointTrajectoryController&quot;</span><span class="p">,</span> <span class="s">&quot;%s cannot execute trajectories(trajectory_msgs/JointTrajectory).&quot;</span><span class="p">,</span> <span class="n">name_</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">done_</span><span class="p">)</span>
      <span class="n">ROS_DEBUG_STREAM_NAMED</span><span class="p">(</span><span class="s">&quot;FollowMultiDOFJointTrajectoryController&quot;</span><span class="p">,</span> <span class="s">&quot;sending trajectory to &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">name_</span><span class="p">);</span>
    <span class="k">else</span>
      <span class="nf">ROS_DEBUG_STREAM_NAMED</span><span class="p">(</span><span class="s">&quot;FollowMultiDOFJointTrajectoryController&quot;</span><span class="p">,</span>
                             <span class="s">&quot;sending continuation for the currently executed trajectory to &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">name_</span><span class="p">);</span>

    <span class="c1">// Send ExecuteTrajectoryGoal message</span>
    <span class="n">moveit_msgs</span><span class="o">::</span><span class="n">ExecuteTrajectoryGoal</span> <span class="n">goal</span><span class="p">;</span>
    <span class="n">goal</span><span class="p">.</span><span class="n">trajectory</span> <span class="o">=</span> <span class="n">trajectory</span><span class="p">;</span>
    <span class="n">controller_action_client_</span><span class="o">-&gt;</span><span class="n">sendGoal</span><span class="p">(</span>
        <span class="n">goal</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FollowMultiDOFJointTrajectoryControllerHandle</span><span class="o">::</span><span class="n">controllerDoneCallback</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">),</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FollowMultiDOFJointTrajectoryControllerHandle</span><span class="o">::</span><span class="n">controllerActiveCallback</span><span class="p">,</span> <span class="k">this</span><span class="p">),</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FollowMultiDOFJointTrajectoryControllerHandle</span><span class="o">::</span><span class="n">controllerFeedbackCallback</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
    <span class="n">done_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">last_exec_</span> <span class="o">=</span> <span class="n">moveit_controller_manager</span><span class="o">::</span><span class="n">ExecutionStatus</span><span class="o">::</span><span class="n">RUNNING</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * @brief Cancel trajecotry execution</span>
<span class="cm">   */</span>
  <span class="kt">bool</span> <span class="n">cancelExecution</span><span class="p">()</span> <span class="k">override</span>
  <span class="p">{</span>
    <span class="c1">// do whatever is needed to cancel execution</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * @brief Wait trajectory execution</span>
<span class="cm">   * @param duration</span>
<span class="cm">   */</span>
  <span class="kt">bool</span> <span class="n">waitForExecution</span><span class="p">(</span><span class="k">const</span> <span class="n">ros</span><span class="o">::</span><span class="n">Duration</span><span class="o">&amp;</span> <span class="n">duration</span><span class="p">)</span> <span class="k">override</span>
  <span class="p">{</span>
    <span class="c1">// wait for the current execution to finish</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>

<span class="k">protected</span><span class="o">:</span>

  <span class="cm">/**</span>
<span class="cm">   * @brief Called when server complete action</span>
<span class="cm">   * @param state</span>
<span class="cm">   * @param result</span>
<span class="cm">   */</span>
  <span class="kt">void</span> <span class="n">controllerDoneCallback</span><span class="p">(</span><span class="k">const</span> <span class="n">actionlib</span><span class="o">::</span><span class="n">SimpleClientGoalState</span><span class="o">&amp;</span> <span class="n">state</span><span class="p">,</span>
                              <span class="k">const</span> <span class="n">moveit_msgs</span><span class="o">::</span><span class="n">ExecuteTrajectoryResultConstPtr</span><span class="o">&amp;</span> <span class="n">result</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// Output custom error message for FollowJointTrajectoryResult if necessary</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">error_code</span><span class="p">.</span><span class="n">val</span> <span class="o">==</span> <span class="n">moveit_msgs</span><span class="o">::</span><span class="n">MoveItErrorCodes</span><span class="o">::</span><span class="n">SUCCESS</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">ROS_INFO_NAMED</span><span class="p">(</span><span class="s">&quot;FollowMultiDOFTrajectoryContoller&quot;</span><span class="p">,</span> <span class="s">&quot;Execution Succeeded.&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="n">ROS_ERROR</span><span class="p">(</span><span class="s">&quot;Returned Error Code %d&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">-&gt;</span><span class="n">error_code</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
        <span class="n">ROS_ERROR</span><span class="p">(</span><span class="s">&quot;For Detailse of Error Code, see moveit_msgs/MoveItErrorCodes.msg&quot;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">ROS_WARN_STREAM</span><span class="p">(</span><span class="s">&quot;Controller &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">name_</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;: no result returned&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">finishControllerExecution</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * @brief Called when goal become active</span>
<span class="cm">   */</span>
  <span class="kt">void</span> <span class="n">controllerActiveCallback</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">ROS_DEBUG_STREAM_NAMED</span><span class="p">(</span><span class="s">&quot;FollowMultiDOFJointTrajectoryController&quot;</span><span class="p">,</span> <span class="n">name_</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; started execution&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * @brief Called when feedback arrived from server</span>
<span class="cm">   * @param feedback</span>
<span class="cm">   */</span>
  <span class="kt">void</span> <span class="n">controllerFeedbackCallback</span><span class="p">(</span><span class="k">const</span> <span class="n">moveit_msgs</span><span class="o">::</span><span class="n">ExecuteTrajectoryFeedbackConstPtr</span><span class="o">&amp;</span> <span class="n">feedback</span><span class="p">)</span>
  <span class="p">{</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="p">}</span>  <span class="c1">// end namespace moveit_multi_dof_controller_manager</span>

<span class="cp">#endif </span><span class="c1">// MOVEIT_PLUGINS_FOLLOW_MULTI_DOF_TRAJECTORY_CONTROLLER_HANDLE</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="id4">
<h2>Controller Manager<a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="literal-block-wrapper container" id="id10">
<div class="code-block-caption"><span class="caption-text">moveit_multi_dof_controller_manager.cpp</span><a class="headerlink" href="#id10" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * @file moveit_multi_dof_controller_manager.cpp</span>
<span class="cm"> * @brief Controller manager for multi DOF joint</span>
<span class="cm"> */</span>

<span class="cp">#include</span> <span class="cpf">&lt;ros/ros.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;moveit/controller_manager/controller_manager.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;dronedoc/follow_multi_dof_joint_trajectory_controller_handle.hpp&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sensor_msgs/JointState.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;pluginlib/class_list_macros.hpp&gt;</span><span class="cp"></span>

<span class="k">namespace</span> <span class="n">moveit_multi_dof_controller_manager</span>
<span class="p">{</span>

<span class="k">class</span> <span class="nc">MoveItMultiDOFControllerManager</span> <span class="o">:</span> <span class="k">public</span> <span class="n">moveit_controller_manager</span><span class="o">::</span><span class="n">MoveItControllerManager</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>

  <span class="cm">/**</span>
<span class="cm">   * @brief Default constructor</span>
<span class="cm">   */</span>
  <span class="n">MoveItMultiDOFControllerManager</span><span class="p">()</span> <span class="o">:</span> <span class="n">node_handle_</span><span class="p">(</span><span class="s">&quot;~&quot;</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// Error if controller_list param is not set</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node_handle_</span><span class="p">.</span><span class="n">hasParam</span><span class="p">(</span><span class="s">&quot;controller_list&quot;</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">ROS_ERROR_STREAM_NAMED</span><span class="p">(</span><span class="s">&quot;manager&quot;</span><span class="p">,</span> <span class="s">&quot;No controller_list specified.&quot;</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">XmlRpc</span><span class="o">::</span><span class="n">XmlRpcValue</span> <span class="n">controller_list</span><span class="p">;</span>
    <span class="n">node_handle_</span><span class="p">.</span><span class="n">getParam</span><span class="p">(</span><span class="s">&quot;controller_list&quot;</span><span class="p">,</span> <span class="n">controller_list</span><span class="p">);</span>

    <span class="c1">// Error if controller_list is not an array</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">controller_list</span><span class="p">.</span><span class="n">getType</span><span class="p">()</span> <span class="o">!=</span> <span class="n">XmlRpc</span><span class="o">::</span><span class="n">XmlRpcValue</span><span class="o">::</span><span class="n">TypeArray</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">ROS_ERROR</span><span class="p">(</span><span class="s">&quot;Parameter controller_list should be specified as an array&quot;</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Error if multiple controller is defined</span>
    <span class="k">if</span><span class="p">(</span><span class="n">controller_list</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">ROS_ERROR</span><span class="p">(</span><span class="s">&quot;This controller manager expects only one controller.&quot;</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Error if controller not have required fields</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">controller_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">hasMember</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">controller_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">hasMember</span><span class="p">(</span><span class="s">&quot;joints&quot;</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">ROS_ERROR_STREAM_NAMED</span><span class="p">(</span><span class="s">&quot;manager&quot;</span><span class="p">,</span> <span class="s">&quot;Name and joints must be specifed for each controller&quot;</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">try</span>
    <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">controller_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&quot;name&quot;</span><span class="p">]);</span>

      <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">action_ns</span><span class="p">;</span>

      <span class="c1">// Warn if controller has &quot;ns&quot; field</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">controller_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">hasMember</span><span class="p">(</span><span class="s">&quot;ns&quot;</span><span class="p">))</span>
      <span class="p">{</span>
        <span class="n">action_ns</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">controller_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&quot;ns&quot;</span><span class="p">]);</span>
        <span class="n">ROS_WARN_NAMED</span><span class="p">(</span><span class="s">&quot;manager&quot;</span><span class="p">,</span> <span class="s">&quot;Use of &#39;ns&#39; is deprecated, use &#39;action_ns&#39; instead.&quot;</span><span class="p">);</span>
      <span class="p">}</span> <span class="c1">// Set action namespace</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">controller_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">hasMember</span><span class="p">(</span><span class="s">&quot;action_ns&quot;</span><span class="p">))</span>
        <span class="n">action_ns</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">controller_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&quot;action_ns&quot;</span><span class="p">]);</span>
      <span class="k">else</span> <span class="c1">// Warn if &quot;action_ns&quot; not specified</span>
        <span class="n">ROS_WARN_NAMED</span><span class="p">(</span><span class="s">&quot;manager&quot;</span><span class="p">,</span> <span class="s">&quot;Please note that &#39;action_ns&#39; no longer has a default value.&quot;</span><span class="p">);</span>

      <span class="c1">// Error if &quot;joints&quot; field is not array</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">controller_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&quot;joints&quot;</span><span class="p">].</span><span class="n">getType</span><span class="p">()</span> <span class="o">!=</span> <span class="n">XmlRpc</span><span class="o">::</span><span class="n">XmlRpcValue</span><span class="o">::</span><span class="n">TypeArray</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">ROS_ERROR_STREAM_NAMED</span><span class="p">(</span><span class="s">&quot;manager&quot;</span><span class="p">,</span> <span class="s">&quot;The list of joints for controller &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">name</span>
                                                                               <span class="o">&lt;&lt;</span> <span class="s">&quot; is not specified as an array&quot;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="c1">// Error if controller not have &quot;type&quot; field</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">controller_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">hasMember</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">))</span>
      <span class="p">{</span>
        <span class="n">ROS_ERROR_STREAM_NAMED</span><span class="p">(</span><span class="s">&quot;manager&quot;</span><span class="p">,</span> <span class="s">&quot;No type specified for controller &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">name</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">type</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">controller_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&quot;type&quot;</span><span class="p">]);</span>

      <span class="c1">// Set controller handle if &quot;type&quot; is FollowMultiDOFJointTrajectory</span>
      <span class="n">moveit_simple_controller_manager</span><span class="o">::</span><span class="n">ActionBasedControllerHandleBasePtr</span> <span class="n">new_handle</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="s">&quot;FollowMultiDOFJointTrajectory&quot;</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">new_handle</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">FollowMultiDOFJointTrajectoryControllerHandle</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">action_ns</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">FollowMultiDOFJointTrajectoryControllerHandle</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">new_handle</span><span class="p">.</span><span class="n">get</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">isConnected</span><span class="p">())</span>
        <span class="p">{</span>
          <span class="n">ROS_INFO_STREAM_NAMED</span><span class="p">(</span><span class="s">&quot;manager&quot;</span><span class="p">,</span> <span class="s">&quot;Added FollowJointTrajectory controller for &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">name</span><span class="p">);</span>
          <span class="n">controller_</span> <span class="o">=</span> <span class="n">new_handle</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="n">ROS_ERROR_STREAM_NAMED</span><span class="p">(</span><span class="s">&quot;manager&quot;</span><span class="p">,</span> <span class="s">&quot;Unknown controller type: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">type</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="cm">/* add list of joints, used by controller manager and MoveIt! */</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">controller_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&quot;joints&quot;</span><span class="p">].</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="n">controller_</span><span class="o">-&gt;</span><span class="n">addJoint</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">controller_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&quot;joints&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]));</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(...)</span>
    <span class="p">{</span>
      <span class="n">ROS_ERROR_STREAM_NAMED</span><span class="p">(</span><span class="s">&quot;manager&quot;</span><span class="p">,</span> <span class="s">&quot;Caught unknown exception while parsing controller information&quot;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * @brief Destructor</span>
<span class="cm">   */</span>
  <span class="o">~</span><span class="n">MoveItMultiDOFControllerManager</span><span class="p">()</span> <span class="k">override</span>
  <span class="p">{</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * @brief Returns pointer to controller handle</span>
<span class="cm">   * @param name</span>
<span class="cm">   */</span>
  <span class="n">moveit_controller_manager</span><span class="o">::</span><span class="n">MoveItControllerHandlePtr</span> <span class="n">getControllerHandle</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">)</span> <span class="k">override</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">moveit_controller_manager</span><span class="o">::</span><span class="n">MoveItControllerHandlePtr</span><span class="o">&gt;</span><span class="p">(</span><span class="n">controller_</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * @brief Add FollowMultiDOFJointTrajectory to controller list</span>
<span class="cm">   * @param names</span>
<span class="cm">   *</span>
<span class="cm">   * This manager only deals FollowMultiDOFJointTrajectory controller</span>
<span class="cm">   */</span>
  <span class="kt">void</span> <span class="n">getControllersList</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">names</span><span class="p">)</span> <span class="k">override</span>
  <span class="p">{</span>
    <span class="n">names</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="s">&quot;FollowMultiDOFJointTrajectory&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * @brief Get all controllers</span>
<span class="cm">   * @param names</span>
<span class="cm">   *</span>
<span class="cm">   * This plugin assumes that all controllers are already active -- and if they are not, well, it has no way to deal</span>
<span class="cm">   * with it anyways!</span>
<span class="cm">   */</span>
  <span class="kt">void</span> <span class="n">getActiveControllers</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">names</span><span class="p">)</span> <span class="k">override</span>
  <span class="p">{</span>
    <span class="n">getControllersList</span><span class="p">(</span><span class="n">names</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * @brief Get all controllers</span>
<span class="cm">   * @param names</span>
<span class="cm">   *</span>
<span class="cm">   * Controller must be loaded to be active, see comment above about active controllers...</span>
<span class="cm">   */</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">getLoadedControllers</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">names</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">getControllersList</span><span class="p">(</span><span class="n">names</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * @brief Get the list of joints that a controller can control.</span>
<span class="cm">   * @param name Controller name</span>
<span class="cm">   * @param joints List of joints</span>
<span class="cm">   */</span>
  <span class="kt">void</span> <span class="n">getControllerJoints</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">joints</span><span class="p">)</span> <span class="k">override</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s">&quot;FollowMultiDOFJointTrajectory&quot;</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">controller_</span><span class="o">-&gt;</span><span class="n">getJoints</span><span class="p">(</span><span class="n">joints</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">ROS_WARN_NAMED</span><span class="p">(</span><span class="s">&quot;manager&quot;</span><span class="p">,</span> <span class="s">&quot;The joints for controller &#39;%s&#39; are not known. Perhaps the controller configuration is &quot;</span>
                                <span class="s">&quot;not loaded on the param server?&quot;</span><span class="p">,</span>
                     <span class="n">name</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
      <span class="n">joints</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * @brief Get state of controller specified by name</span>
<span class="cm">   * @param name</span>
<span class="cm">   *</span>
<span class="cm">   * Controllers are all active and default.</span>
<span class="cm">   */</span>
  <span class="n">moveit_controller_manager</span><span class="o">::</span><span class="n">MoveItControllerManager</span><span class="o">::</span><span class="n">ControllerState</span>
  <span class="n">getControllerState</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">)</span> <span class="k">override</span>
  <span class="p">{</span>
    <span class="n">moveit_controller_manager</span><span class="o">::</span><span class="n">MoveItControllerManager</span><span class="o">::</span><span class="n">ControllerState</span> <span class="n">state</span><span class="p">;</span>
    <span class="n">state</span><span class="p">.</span><span class="n">active_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">state</span><span class="p">.</span><span class="n">default_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">state</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * @brief Switch controllers</span>
<span class="cm">   * @param activate</span>
<span class="cm">   * @param deactivate</span>
<span class="cm">   *</span>
<span class="cm">   * Cannot switch our controllers</span>
<span class="cm">   */</span>
  <span class="kt">bool</span> <span class="n">switchControllers</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">activate</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">deactivate</span><span class="p">)</span> <span class="k">override</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span>

<span class="k">protected</span><span class="o">:</span>
  <span class="n">ros</span><span class="o">::</span><span class="n">NodeHandle</span> <span class="n">node_handle_</span><span class="p">;</span>
  <span class="n">moveit_simple_controller_manager</span><span class="o">::</span><span class="n">ActionBasedControllerHandleBasePtr</span> <span class="n">controller_</span><span class="p">;</span>
<span class="p">};</span>

<span class="p">}</span>  <span class="c1">// end namespace moveit_multi_dof_controller_manager</span>

<span class="n">PLUGINLIB_EXPORT_CLASS</span><span class="p">(</span><span class="n">moveit_multi_dof_controller_manager</span><span class="o">::</span><span class="n">MoveItMultiDOFControllerManager</span><span class="p">,</span>
                       <span class="n">moveit_controller_manager</span><span class="o">::</span><span class="n">MoveItControllerManager</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="moveit-multi-dof-controller-manager-plugin-description-xml">
<h3>moveit_multi_dof_controller_manager_plugin_description.xml<a class="headerlink" href="#moveit-multi-dof-controller-manager-plugin-description-xml" title="このヘッドラインへのパーマリンク">¶</a></h3>
</div>
<div class="section" id="cmakelists-txt">
<h3>CMakeLists.txt<a class="headerlink" href="#cmakelists-txt" title="このヘッドラインへのパーマリンク">¶</a></h3>
</div>
<div class="section" id="package-xml">
<h3>package.xml<a class="headerlink" href="#package-xml" title="このヘッドラインへのパーマリンク">¶</a></h3>
</div>
</div>
<div class="section" id="launch-files">
<h2>Launch files<a class="headerlink" href="#launch-files" title="このヘッドラインへのパーマリンク">¶</a></h2>
<ul class="simple">
<li>iris_moveit.launch</li>
<li>iris_moveit_controller_manager.launch.xml</li>
<li>trajectory_execution.launch</li>
</ul>
<div class="section" id="controller-yaml">
<h3>controller.yaml<a class="headerlink" href="#controller-yaml" title="このヘッドラインへのパーマリンク">¶</a></h3>
</div>
</div>
<div class="section" id="execution">
<h2>Execution<a class="headerlink" href="#execution" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>シミュレーション環境とMoveIt!のノードを起動します。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre>roslaunch px4_sim_pkg iris_moveit.Launch
</pre></div>
</div>
<p>経路計画用にMoveIt!のプラグインを含むRVizを起動します。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre>roslaunch iris_moveit_config moveit_rviz.launch config:<span class="o">=</span><span class="nb">true</span>
</pre></div>
</div>
<p>ドローンを離陸させてから設定を行い、&quot;Planning&quot;タブから&quot;Plan&quot;をクリックすると生成されたパスがRVizに表示されます。
スタートが離陸前の位置になっている場合には、&quot;Planning&quot;タブの&quot;Query&quot;にある、&quot;Select Start State&quot;のプルダウンメニューを&quot;current&quot;にして&quot;Update&quot;ボタンを押して現在の位置をスタートとして設定します。</p>
<p>&quot;Execute&quot;ボタンを押すと、<code class="docutils literal notranslate"><span class="pre">follow_multi_dof_joint_trajectory</span></code> アクションのサーバーにゴールが送信され、アクションサーバーがmavrosのトピックを通じて目標位置を送信し始めます。
<code class="docutils literal notranslate"><span class="pre">/mavros/setpoint_position/local</span></code> トピックのメッセージを使ってドローンを制御するために、モードをOFFBOARDに変更します。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre>rosrun mavros mavsys mode -c OFFBOARD
</pre></div>
</div>
<p>以下のようにドローンが目標位置に移動すれば成功です。</p>
<img alt="../../../_images/planning.gif" src="../../../_images/planning.gif" />
<p>障害物がある場合にはそれを回避する経路を生成してくれます。</p>
<img alt="../../../_images/collision.gif" src="../../../_images/collision.gif" />
</div>
<div class="section" id="id5">
<h2>まとめ<a class="headerlink" href="#id5" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>この記事では、MoveIt!を用いて計画した経路の経由点をmavros経由でドローンに送ることでドローンを移動させました。</p>
<p>今回は生成された経路を線形補間を用いて補間し、それを <code class="docutils literal notranslate"><span class="pre">setpoint_position</span></code> トピックに与えることでドローンを制御しましたが、<a class="reference external" href="http://wiki.ros.org/mavros#mavros.2BAC8-Plugins.waypoint">waypoint</a> を用いたドローンの位置制御を試してみてもいいかもしれません。</p>
</div>
<div class="section" id="id6">
<h2>参考<a class="headerlink" href="#id6" title="このヘッドラインへのパーマリンク">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://github.com/ros-planning/moveit_pr2">https://github.com/ros-planning/moveit_pr2</a></li>
<li><a class="reference external" href="https://github.com/ros-planning/moveit">https://github.com/ros-planning/moveit</a></li>
</ul>
<div class="section" id="move-group-interface">
<h3>Move Group Interface<a class="headerlink" href="#move-group-interface" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>今回はRVizからゴールやプランナの設定等を行いましたが、C++やPythonのコードからこれらの設定を行うためのインターフェースが用意されています。</p>
<ul class="simple">
<li><a class="reference external" href="http://docs.ros.org/kinetic/api/moveit_tutorials/html/doc/move_group_interface/move_group_interface_tutorial.html">Move Group C++ Interface</a></li>
<li><a class="reference external" href="http://docs.ros.org/kinetic/api/moveit_tutorials/html/doc/move_group_python_interface/move_group_python_interface_tutorial.html">Move Group Python Interface</a></li>
</ul>
</div>
<div class="section" id="id7">
<h3>マニピュレータの制御<a class="headerlink" href="#id7" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ul class="simple">
<li><a class="reference external" href="https://sites.google.com/site/robotlabo/time-tracker/ros/ros-manipulator">ROSによるマニピュレータの制御</a></li>
<li><a class="reference external" href="https://sites.google.com/site/robotlabo/time-tracker/ros/gazebo_mani">Gazeboによるマニピュレータのシミュレーション</a></li>
</ul>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../../appendix/bash_commands/bash_commands.html" class="btn btn-neutral float-right" title="基本的なBashの使い方" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../run_demo/run_demo.html" class="btn btn-neutral" title="MoveIt!のRvizデモを試す" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Takaki Ueno

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/translations.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

  

  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>